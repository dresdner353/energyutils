<head>
    <meta id="META" name="viewport" content="width=device-width, initial-scale=1.0" >
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>SolarMon Admin</title>

    <script>
        $(document ).ready(function() {
            // form setup prevent default POST/GET
            $("form").submit(function(e){
                e.preventDefault();
            });

            // custom handler function for apply button 
            $("#apply_button").click(function() {
                apply_config();
            }); 

            // get the config
            var data_request = $.get('/config');

            data_request.done(function(data) {

                // JSON parse response
                config_dict = JSON.parse(data);
                //console.log(config_dict);

                // assert configured data source
                $('#data_source').val(config_dict['data_source']);
                toggle_config();

                if ('shelly' in config_dict){
                    $('#shelly_auth_key').val(config_dict['shelly']['auth_key']);
                    $('#shelly_api_host').val(config_dict['shelly']['api_host']);
                    $('#shelly_device_id').val(config_dict['shelly']['device_id']);
                    $('#shelly_device_host').val(config_dict['shelly']['device_host']);
                    $('#shelly_device_username').val(config_dict['shelly']['device_username']);
                    $('#shelly_device_password').val(config_dict['shelly']['device_password']);
                }

                if ('solis' in config_dict){
                    $('#solis_inverter_sn').val(config_dict['solis']['inverter_sn']);
                    $('#solis_api_host').val(config_dict['solis']['api_host']);
                    $('#solis_key_id').val(config_dict['solis']['key_id']);
                    $('#solis_key_secret').val(config_dict['solis']['key_secret']);
                }

                // metrics
                $("#metrics_live").prop("checked", config_dict['dashboard']['metrics']['live']);
                $("#metrics_today").prop("checked", config_dict['dashboard']['metrics']['today']);
                $("#metrics_yesterday").prop("checked", config_dict['dashboard']['metrics']['yesterday']);
                $("#metrics_this_month").prop("checked", config_dict['dashboard']['metrics']['this_month']);
                $("#metrics_last_month").prop("checked", config_dict['dashboard']['metrics']['last_month']);
                $("#metrics_last_12_months").prop("checked", config_dict['dashboard']['metrics']['last_12_months']);
                $('#metric_cycle_interval').val(config_dict['dashboard']['cycle_interval']);

                // donut
                $("#donut_import").prop("checked", config_dict['dashboard']['donut']['import']);
                $("#donut_consumed").prop("checked", config_dict['dashboard']['donut']['consumed']);
                $("#donut_solar").prop("checked", config_dict['dashboard']['donut']['solar']);
                $("#donut_export").prop("checked", config_dict['dashboard']['donut']['export']);
                $("#donut_solar_consumed").prop( "checked", config_dict['dashboard']['donut']['solar_consumed']);
                $("#donut_battery_charge").prop("checked", config_dict['dashboard']['donut']['battery_charge']);
                $("#donut_battery_discharge").prop("checked", config_dict['dashboard']['donut']['battery_discharge']);

                // bar charts
                $("#bar_chart_import").prop("checked", config_dict['dashboard']['bar_chart']['import']);
                $("#bar_chart_consumed").prop("checked", config_dict['dashboard']['bar_chart']['consumed']);
                $("#bar_chart_solar").prop("checked", config_dict['dashboard']['bar_chart']['solar']);
                $("#bar_chart_export").prop("checked", config_dict['dashboard']['bar_chart']['export']);
                $("#bar_chart_solar_consumed").prop( "checked", config_dict['dashboard']['bar_chart']['solar_consumed']);
                $("#bar_chart_battery_charge").prop("checked", config_dict['dashboard']['bar_chart']['battery_charge']);
                $("#bar_chart_battery_discharge").prop("checked", config_dict['dashboard']['bar_chart']['battery_discharge']);

                if ('environment' in config_dict){
                    $('#env_gco2_kwh').val(config_dict['environment']['gco2_kwh']);
                    $('#env_trees_kwh').val(config_dict['environment']['trees_kwh']);
                }
            });
        });

        function toggle_passwords() {
            if ($('#show_passwords').prop('checked')) {
                $("input[type='password']").prop('type', 'text');
            }
            else {
                $("input[type='text']").prop('type', 'password');
            }
        }

        function toggle_config() {
            var data_source = $('#data_source').find(":selected").val();

            // hide all data source sections
            $("#shelly_config").hide();
            $("#solis_config").hide();
            $("#sofar_config").hide();
            $("#huawei_config").hide();

            // then show the selected one
            switch(data_source) {
              case "shelly-em":
              $("#shelly_config").show();
              break;

              case "solis":
              $("#solis_config").show();
              break;

              case "sofar":
              $("#sofar_config").show();
              break;

              case "huawei":
              $("#huawei_config").show();
              break;
            }
        }

        // format action handler
        function apply_config() {
            config_dict = {};

            config_dict['data_source'] = $('#data_source').val();

            config_dict['shelly'] = {}
            config_dict['shelly']['auth_key'] = $('#shelly_auth_key').val();
            config_dict['shelly']['api_host'] = $('#shelly_api_host').val();
            config_dict['shelly']['device_id'] = $('#shelly_device_id').val();
            config_dict['shelly']['device_host'] = $('#shelly_device_host').val();
            config_dict['shelly']['device_username'] = $('#shelly_device_username').val();
            config_dict['shelly']['device_password'] = $('#shelly_device_password').val();

            config_dict['solis'] = {}
            config_dict['solis']['inverter_sn'] = $('#solis_inverter_sn').val();
            config_dict['solis']['api_host'] = $('#solis_api_host').val();
            config_dict['solis']['key_id'] = $('#solis_key_id').val();
            config_dict['solis']['key_secret'] = $('#solis_key_secret').val();

            config_dict['dashboard'] = {}

            config_dict['dashboard']['metrics'] = {}
            config_dict['dashboard']['metrics']['live'] =  $('#metrics_live').prop('checked');
            config_dict['dashboard']['metrics']['today'] = $('#metrics_today').prop('checked');
            config_dict['dashboard']['metrics']['yesterday'] = $('#metrics_yesterday').prop('checked');
            config_dict['dashboard']['metrics']['this_month'] = $('#metrics_this_month').prop('checked');
            config_dict['dashboard']['metrics']['last_month'] = $('#metrics_last_month').prop('checked');
            config_dict['dashboard']['metrics']['last_12_months'] = $('#metrics_last_12_months').prop('checked');
            config_dict['dashboard']['cycle_interval'] = $('#metric_cycle_interval').val();

            config_dict['dashboard']['donut'] = {}
            config_dict['dashboard']['donut']['import'] = $('#donut_import').prop('checked');
            config_dict['dashboard']['donut']['consumed'] = $('#donut_consumed').prop('checked');
            config_dict['dashboard']['donut']['solar'] = $('#donut_solar').prop('checked');
            config_dict['dashboard']['donut']['export'] = $('#donut_export').prop('checked');
            config_dict['dashboard']['donut']['solar_consumed'] = $('#donut_solar_consumed').prop('checked');
            config_dict['dashboard']['donut']['battery_charge'] = $('#donut_battery_charge').prop('checked');
            config_dict['dashboard']['donut']['battery_discharge'] = $('#donut_battery_discharge').prop('checked');

            config_dict['dashboard']['bar_chart'] = {}
            config_dict['dashboard']['bar_chart']['import'] = $('#bar_chart_import').prop('checked');
            config_dict['dashboard']['bar_chart']['consumed'] = $('#bar_chart_consumed').prop('checked');
            config_dict['dashboard']['bar_chart']['solar'] = $('#bar_chart_solar').prop('checked');
            config_dict['dashboard']['bar_chart']['export'] = $('#bar_chart_export').prop('checked');
            config_dict['dashboard']['bar_chart']['solar_consumed'] = $('#bar_chart_solar_consumed').prop('checked');
            config_dict['dashboard']['bar_chart']['battery_charge'] = $('#bar_chart_battery_charge').prop('checked');
            config_dict['dashboard']['bar_chart']['battery_discharge'] = $('#bar_chart_battery_discharge').prop('checked');

            config_dict['environment'] = {}
            config_dict['environment']['gco2_kwh'] = Number($('#env_gco2_kwh').val());
            config_dict['environment']['trees_kwh'] = Number($('#env_trees_kwh').val());

            // JSON POST to /config
            post_body = JSON.stringify(config_dict)
            request = new XMLHttpRequest();
            request.open('POST', '/config', true)
            request.setRequestHeader('Content-type', 'application/json; charset=UTF-8')
            request.send(post_body);
            request.onload = function () {
                if(request.status == 200) {
                    console.log("config update success") 
                }
            }
        }

    </script>

</head>

<body>
    <form>
        <div id="dashboard" class="container">
            <h2>Solar Monitor Settings</h2>
            <div class="row">
                <div class="col-lg-8 col-xs-12 col-centered">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Data Source</h5>

                            <div class="row">
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Inverter/Cloud Source</span>
                                    <select id="data_source" class="form-select" onchange="toggle_config()">
                                        <option value="shelly-em">Shelly EM Device & Shelly Cloud</option>
                                        <option value="solis">Solis Cloud</option>
                                        <option value="sofar">Sofar Cloud</option>
                                        <option value="huawei">Huawei Cloud</option>
                                    </select>
                                </div>
                            </div>

                            <div id="shelly_config">
                                <div class="form-floating mb-3">
                                    <input type="password" class="form-control" id="shelly_auth_key" placeholder="XXXXXXXX">
                                    <label for="shelly_auth_key">Shelly Cloud Authentication Key</label>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="shelly_api_host" placeholder="shelly-XX-eu.shelly.cloud">
                                            <label for="shelly_api_host">Shelly Cloud API Hostname</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="shelly_device_id" placeholder="xxxxxxxx">
                                            <label for="shelly_device_id">Shelly EM Device ID</label>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="shelly_device_host" placeholder="shellyem-xxxxxxxxxx.local">
                                            <label for="shelly_device_host">Shelly EM Device Hostname/IP</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="shelly_device_username" placeholder="username">
                                            <label for="shelly_device_username">Shelly EM Device Username</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="shelly_device_password" placeholder="password">
                                            <label for="shelly_device_password">Shelly EM Device Password</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="solis_config">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="solis_api_host" placeholder="soliscloud.com:PPPPP">
                                            <label for="solis_api_host">Solis Cloud API Hostname</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="solis_key_id" placeholder="xxxxxxxx">
                                            <label for="solis_key_id">Solis Key ID</label>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="solis_inverter_sn" placeholder="xxxxxxxxx">
                                            <label for="solis_inverter_sn">Solis Inverter SN</label>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="solis_key_secret" placeholder="xxxxxxxxx">
                                            <label for="solis_key_secret">Solis Key Secret</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="row row-cols-2 mt-3">

                        <div id="metrics_config" class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Donut Metrics Sources</h5>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_live">
                                        <label class="form-check-label" for="metrics_live">Live</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_today">
                                        <label class="form-check-label" for="metrics_today">Today</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_yesterday">
                                        <label class="form-check-label" for="metrics_yesterday">Yesterday</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_this_month">
                                        <label class="form-check-label" for="metrics_this_month">This Month</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_last_month">
                                        <label class="form-check-label" for="metrics_last_month">Last Month</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="metrics_last_12_months">
                                        <label class="form-check-label" for="metrics_last_12_months">Last 12 Months</label>
                                    </div>

                                    <div class="row">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">Cycle Period</span>
                                            <select id="metric_cycle_interval" class="form-select">
                                                <option value="1">1s</option>
                                                <option value="2">2s</option>
                                                <option value="3">3s</option>
                                                <option value="5">5s</option>
                                                <option value="8">8s</option>
                                                <option value="10">10s</option>
                                                <option value="15">15s</option>
                                                <option value="20">20s</option>
                                                <option value="30">30s</option>
                                                <option value="60">60s</option>
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div id="donut_config" class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Donut Chart Series</h5>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_import">
                                        <label class="form-check-label" for="donut_import">Grid Import</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_consumed">
                                        <label class="form-check-label" for="donut_consumed">Total Consumption</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_solar">
                                        <label class="form-check-label" for="donut_solar">PV Yield</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_solar_consumed">
                                        <label class="form-check-label" for="donut_solar_consumed">PV Consumption</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_export">
                                        <label class="form-check-label" for="donut_export">PV Export</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_battery_charge">
                                        <label class="form-check-label" for="donut_battery_charge">Battery Charge</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="donut_battery_discharge">
                                        <label class="form-check-label" for="donut_battery_discharge">Battery Discharge</label>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div id="chart_config" class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Column Chart Series</h5>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_import">
                                        <label class="form-check-label" for="bar_chart_import">Grid Import</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_consumed">
                                        <label class="form-check-label" for="bar_chart_consumed">Total Consumption</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_solar">
                                        <label class="form-check-label" for="bar_chart_solar">PV Yield</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_solar_consumed">
                                        <label class="form-check-label" for="bar_chart_solar_consumed">PV Consumption</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_export">
                                        <label class="form-check-label" for="bar_chart_export">PV Export</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_battery_charge">
                                        <label class="form-check-label" for="bar_chart_battery_charge">Battery Charge</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bar_chart_battery_discharge">
                                        <label class="form-check-label" for="bar_chart_battery_discharge">Battery Discharge</label>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div id="env_config" class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Environment Settings</h5>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="env_gco2_kwh" placeholder="gggg">
                                        <label for="env_gco2_kwh">CO2g per kWh</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="env_trees_kwh" placeholder="tttt">
                                        <label for="env_trees_kwh">Trees Planted per kWh</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="general_config" class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">General Settings</h5>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="show_passwords" onchange="toggle_passwords()">
                                        <label class="form-check-label" for="show_passwords">Show Passwords/Keys</label>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                    <button type="submit" class="btn btn-primary mt-4" id="apply_button">Apply</button>
                    <a class="btn btn-primary mt-4" href="/" role="button">Show Dashboard</a>
                </div>
            </div>
        </div>
    </form>
</body>
