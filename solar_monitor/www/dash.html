<head>   
    <meta id="META" name="viewport" content="width=device-width, initial-scale=1.0" >
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <meta name="mobile-web-app-capable" content="yes">
    <link href="/dash.css" rel="stylesheet">
    <title>Solar Monitor</title>

    <script>
        // Google charts
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.load('current', {'packages':['gauge']});

        // data dict as taken from the /data GET
        var data_dict = {
            year: [],
            month: [],
            day: []
        };

        // refresh timer 
        // initalised with a short initial value for the first load
        var refresh_interval = 1000
        var refresh_timer = setInterval(refresh_data, refresh_interval);

        // metric cycle timer also initialised with a short
        // timer
        var metric_cycle_interval = 1000;
        var metric_cycle_timer = setInterval(cycle_metric_index, metric_cycle_interval);

        // global string for selected layout
        var layout;

        // document load
        $( document ).ready(function() {
            console.log("ready()");
            // hide the dashboard and splash initially
            $("#dashboard").hide();
            $("#splash").show();

            // set dash to blank text
            // layout will over-ride this
            $("#dashboard").html("");

            set_layout();
            refresh_data();
            display_data();
        });

        // Window focus changes activates/deactivates 
        // the timers to avoid background activity when not in focus
        $(window).focus(function() {
            clearInterval(refresh_timer);
            refresh_timer = setInterval(refresh_data, refresh_interval);

            clearInterval(metric_cycle_timer);
            metric_cycle_timer = setInterval(cycle_metric_index, metric_cycle_interval);

            display_data();

        }).blur(function() {

            clearInterval(refresh_timer);
            clearInterval(metric_cycle_timer);

        });

        // forced redraw of everything on resize
        $(window).resize(function () { 
            set_layout();
            display_data();
        });

        // determines the window dimensions and sets the 
        // appropriate layout template
        function set_layout() {
            var window_height = window.innerHeight;
            var window_width = window.innerWidth;

            console.log("set_layout()");
            console.log("Window dims.. w:" + window_width + " h:" + window_height);

            agg_donut_html = ` 
            <div id="agg_donut_chart" class="card-transparent text-white text-center mt-2">
                <div class="card-body text-center">
                    <center>
                        <a href="/admin"><div id="agg_donut_title" class="title"></div></a>
                        <div onclick="ui_cycle_metric_index()" id="donut_chart"></div>
                    </center>
                </div>
            </div>
            `;

            agg_metrics_html = `
                <div id="agg_metrics" class="container text-white text-center">
                    <div class="row row-cols-2">

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_import" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_import_icon" class="material-icons metric">login</div>
                                                <div id="agg_import_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_export" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_export_icon" class="material-icons metric">logout</div>
                                                <div id="agg_export_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="agg_battery_charge_col" class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_battery_charge" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_battery_charge_icon" class="material-icons metric">battery_charging_full</div>
                                                <div id="agg_battery_charge_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="agg_battery_discharge_col" class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_battery_discharge" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_battery_discharge_icon" class="material-icons metric">battery_4_bar</div>
                                                <div id="agg_battery_discharge_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="agg_battery_soc_col" class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_battery_soc" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_battery_soc_icon" class="material-icons metric"></div>
                                                <div id="agg_battery_soc_unit" class="metric-unit metric-white">%</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_solar" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_solar_icon" class="material-icons metric">solar_power</div>
                                                <div id="agg_solar_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_consumed" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_consumed_icon" class="material-icons metric">home</div>
                                                <div id="agg_consumed_unit" class="metric-unit metric-white">kWh</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_co2" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_co2_icon" class="material-icons metric">co2</div>
                                                <div id="agg_co2_unit" class="metric-unit metric-white">kg</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card-transparent text-center mt-0">
                                <div class="card-body">
                                    <table border="0" align="center">
                                        <tr>
                                            <td style="vertical-align: middle;">
                                                <span id="agg_trees" style="metric metric-white">0</span>
                                            </td>
                                            <td style="vertical-align: middle;" align="center">
                                                <div id="agg_trees_icon" class="material-icons metric">forest</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            `;

            day_column_chart_html = `
                <div id="day_column_chart" class="col mt-2">
                    <center><div id="day_chart_title" class="title"></div></center>
                    <div id="day_google_chart"></div>
                </div>
            `;

            month_column_chart_html = `
                <div id="month_column_chart"class="col mt-2">
                    <center><div id="month_chart_title" class="title"></div></center>
                    <div id="month_google_chart"></div>
                </div>
            `;

            year_column_chart_html = `
                <div id="year_column_chart"class="col mt-2">
                    <center><div id="year_chart_title" class="title"></div></center>
                    <div id="year_google_chart"></div>
                </div>
            `

            // layout templates
            // these will be substituted into the top-level 
            // body to complete re-arrange the screen according to the 
            // selected screen size
            // it was too complex to try and dynamically change various bootstrap
            // class values etc to try and tweak a common layout to obey

            // large screen model
            // two columns, split 5:7 on bootstrap 12 breakpoints
            // left column has the donut and metrics and right
            // has the three column charts
            large_screen_layout = `
                <div class="container-fluid" data-bs-theme="dark">
                    <div class="row">
                        <div class="col col-5 mt-2">
                            <div id="agg_donut_insert" class="row">
                            </div>
                            <div id="agg_metrics_insert" class="row">
                            </div>
                        </div>

                        <div id="chart_column" class="col col-7 mt-2">
                            <div id="day_column_chart_insert" class="row">
                            </div>

                            <div id="month_column_chart_insert" class="row">
                            </div>

                            <div id="year_column_chart_insert" class="row">
                            </div>

                        </div>
                    </div>
                </div>
            `;

            // small screen model
            // 5:7 split columns
            // donut on  left, metrics stack on right
            small_screen_layout = `
                <div class="container-fluid" data-bs-theme="dark">
                    <div class="row">
                        <div id="agg_donut_insert" class="col col-5 mt-2">
                        </div>
                        <div id="agg_metrics_insert" class="col col-7 mt-2">
                        </div>
                    </div>
                </div>
            `;

            // portrait screen model
            // vertical stack of everything
            // in a series of rows, one column
            // each. Works for phones and portrait
            // tablets or monitors
            portrait_screen_layout = `
                <div class="container-fluid" data-bs-theme="dark">
                    <div id="agg_donut_insert" class="row">
                    </div>

                    <div id="agg_metrics_insert" class="row">
                    </div>

                    <div id="day_column_chart_insert" class="row">
                    </div>

                    <div id="month_column_chart_insert" class="row">
                    </div>

                    <div id="year_column_chart_insert" class="row">
                    </div>

                    </div>
                </div>
            `;

            // layout checks
            if (window_width <= window_height) {
                // portrait view
                layout = "portrait";
                $("#dashboard").html(portrait_screen_layout);
                $("#agg_donut_insert").html(agg_donut_html);
                $("#agg_metrics_insert").html(agg_metrics_html);
                $("#day_column_chart_insert").html(day_column_chart_html);
                $("#month_column_chart_insert").html(month_column_chart_html);
                $("#year_column_chart_insert").html(year_column_chart_html);

                // set the portrait screen font sizes
                document.body.style.setProperty("--metric-font-size", 'var(--metric-font-size-portrait-screen)');
                document.body.style.setProperty("--icon-font-size", 'var(--icon-font-size-portrait-screen)');
                document.body.style.setProperty("--metric-unit-font-size", 'var(--metric-unit-font-size-portrait-screen)');
                document.body.style.setProperty("--title-font-size", 'var(--title-font-size-portrait-screen)');
                document.body.style.setProperty("--legend-font-size", 'var(--legend-font-size-portrait-screen)');
                document.body.style.setProperty("--slice-font-size", 'var(--slice-font-size-portrait-screen)');
            }
            else {
                if (window_width < 1600 || window_height < 1080) {
                    // small screen landscape
                    layout = "small";
                    $("#dashboard").html(small_screen_layout);
                    $("#agg_donut_insert").html(agg_donut_html);
                    $("#agg_metrics_insert").html(agg_metrics_html);

                    // set the small screen font sizes
                    document.body.style.setProperty("--metric-font-size", 'var(--metric-font-size-small-screen)');
                    document.body.style.setProperty("--icon-font-size", 'var(--icon-font-size-small-screen)');
                    document.body.style.setProperty("--metric-unit-font-size", 'var(--metric-unit-font-size-small-screen)');
                    document.body.style.setProperty("--title-font-size", 'var(--title-font-size-small-screen)');
                    document.body.style.setProperty("--legend-font-size", 'var(--legend-font-size-small-screen)');
                    document.body.style.setProperty("--slice-font-size", 'var(--slice-font-size-small-screen)');
                }
                else {
                    // large screen landscape
                    layout = "large";
                    $("#dashboard").html(large_screen_layout);
                    $("#agg_donut_insert").html(agg_donut_html);
                    $("#agg_metrics_insert").html(agg_metrics_html);
                    $("#day_column_chart_insert").html(day_column_chart_html);
                    $("#month_column_chart_insert").html(month_column_chart_html);
                    $("#year_column_chart_insert").html(year_column_chart_html);

                    // set the large screen smaller font sizes
                    document.body.style.setProperty("--metric-font-size", 'var(--metric-font-size-large-screen)');
                    document.body.style.setProperty("--icon-font-size", 'var(--icon-font-size-large-screen)');
                    document.body.style.setProperty("--metric-unit-font-size", 'var(--metric-unit-font-size-large-screen)');
                    document.body.style.setProperty("--title-font-size", 'var(--title-font-size-large-screen)');
                    document.body.style.setProperty("--legend-font-size", 'var(--legend-font-size-large-screen)');
                    document.body.style.setProperty("--slice-font-size", 'var(--slice-font-size-large-screen)');
                }
            }

            console.log("Set layout to " + layout);
        }

        // formats an energy value into 
        // standard, mega or milli format with 
        // unit changes and decimal point adjustments
        function format_energy_value(value, std_unit, mega_unit, milli_unit) {
            value_dict = {};

            if (value >= 10000) {
                // mega unit 1dp
                value_dict['value'] = (value / 1000).toFixed(1);
                value_dict['unit'] = mega_unit;
            }
            if (value >= 1000) {
                // mega unit 2dp
                value_dict['value'] = (value / 1000).toFixed(2);
                value_dict['unit'] = mega_unit;
            }
            else if (value >= 100) {
                // standard >= 100 0dp
                value_dict['value'] = value.toFixed(0);
                value_dict['unit'] = std_unit;
            }
            else if (value >= 1) {
                // standard 2dp
                value_dict['value'] = value.toFixed(2);
                value_dict['unit'] = std_unit;
            }
            else {
                // milli unit
                value_dict['value'] = Math.floor(value * 1000);
                value_dict['unit'] = milli_unit;
            }

            return value_dict;
        }

        // formats the number of trees value based on value
        function format_trees(value) {
            value_dict = {};

            if (value >= 100) {
                // no dp
                value_dict['value'] = value.toFixed(0);
                value_dict['unit'] = 'trees';
            }
            else if (value >= 1) {
                // 2 dp
                value_dict['value'] = value.toFixed(2);
                value_dict['unit'] = 'trees';
            }
            else if (value >= 0.001) {
                // 3dp
                value_dict['value'] = value.toFixed(3);
                value_dict['unit'] = 'trees';
            }
            else {
                // 0/neglible value, 0dp
                value_dict['value'] = 0;
                value_dict['unit'] = 'trees';
            }

            return value_dict;
        }

        // selects a battery capacity unit based on the soc (percentage)
        function format_battery_icon(battery_soc) {

            battery_icons = [
                    'battery_0_bar',
                    'battery_1_bar',
                    'battery_2_bar',
                    'battery_3_bar',
                    'battery_4_bar',
                    'battery_5_bar',
                    'battery_6_bar',
                    'battery_full',
                ];

            percent_per_band = 100 / battery_icons.length;

            i = -1;
            ref_soc = 0;

            while (ref_soc < battery_soc) {
                ref_soc += percent_per_band;
                i++;
            }

            return(battery_icons[i]);
        }

        // data refresh globals
        var refresh_error_count = 0;
        var first_refresh = 1;

        // refreshes API data for 
        // constructing the dashboard
        function refresh_data() {
            console.log("refresh_data()");

            // get the latest data
            var data_request = $.get('/data');

            // display the get error
            data_request.fail(function() {
                refresh_error_count += 1;
                $("#agg_donut_title").html(`Data Refresh Failure #${refresh_error_count}`);
                data_dict.last_updated = 0;
            });           

            // valid retrieval of data
            data_request.done(function(data) {
                data_dict = JSON.parse(data);

                // on the first retrieval
                // do not react to interval changes
                // seems to cause a delay if we do
                if (first_refresh) {
                    first_refresh = 0;
                    return;
                }

                // check data dict refresh and update if required
                // Note: shown as second and JS operates on msecs
                if ('refresh_interval' in data_dict['dashboard']) {
                    data_dict_refresh = data_dict.dashboard.refresh_interval * 1000;
                    if (refresh_interval != data_dict_refresh) {
                        refresh_interval = data_dict_refresh;

                        // protection of min 1 sec refresh
                        if (refresh_interval < 1000) {
                            refresh_interval = 1000;
                        }

                        // reset timer
                        clearInterval(refresh_timer);
                        refresh_timer = setInterval(refresh_data, refresh_interval);
                        console.log('new refresh interval:' + refresh_interval);
                    }
                }

                if ('cycle_interval' in data_dict['dashboard']) {
                    data_dict_metric_cycle_interval = data_dict.dashboard.cycle_interval * 1000;
                    if (data_dict_metric_cycle_interval != metric_cycle_interval) {
                        metric_cycle_interval = data_dict_metric_cycle_interval;

                        // protection of min 1 sec cycle
                        if (metric_cycle_interval < 1000) {
                            metric_cycle_interval = 1000;
                        }

                        // reset timer
                        clearInterval(metric_cycle_timer);
                        metric_cycle_timer = setInterval(cycle_metric_index, metric_cycle_interval);
                        console.log('new metric cycle interval:' + metric_cycle_interval);
                    }
                }
                display_data();
            });
        }

        // metric series rotation globals
        var agg_metric_index = -1; // init only
        var agg_metric_key = '';

        // rotates the current metric index as 
        // part of the timed cycling
        function cycle_metric_index() {
            console.log("cycle_metric_index()");

            // always default to live
            agg_metric_key = "live";

            metric_list = Object.keys(data_dict.metrics);
            for (i = 0; i < metric_list.length; i++) {
                agg_metric_index = (agg_metric_index + 1) % metric_list.length;

                // check its enabled in the config
                if (data_dict.dashboard.metrics[metric_list[agg_metric_index]]) {
                    agg_metric_key = metric_list[agg_metric_index];
                    break;
                }
            }

            display_data();
        }                                               

        // manual cycle of metyric index
        // and restart of timer
        // used for UI-based tap cycling
        function ui_cycle_metric_index() {
            console.log("force_cycle_metric_index()");
            clearInterval(metric_cycle_timer);
            cycle_metric_index();
            metric_cycle_timer = setInterval(cycle_metric_index, metric_cycle_interval);
        }

        // renders and displays the current dashboard
        function display_data() {
            console.log("display_data()");

            // switch from splash to dashboard 
            // only when we have data to show
            // this is a once-off occurrence at the start
            if ('last_updated' in data_dict && data_dict.last_updated > 0) {
                $("#splash").hide();
                $("#dashboard").show();
            }
            else {
                // display messaage based on configured state
                if (data_dict['configured'] == false) {
                    $("#splash_text").html('Please click setup icon above to continue');
                }
                else {
                    $("#splash_text").html('Waiting for data...');
                }
                return;
            }

            // reset error count
            refresh_error_count = 0;

            // Aggregate metrics
            agg_source = data_dict.metrics[agg_metric_key];
            $("#agg_donut_title").html(agg_source['title']);

            // select units
            if (agg_metric_key == 'live'){
                std_energy_unit = 'kW';
                mega_energy_unit = 'mW';
                milli_energy_unit = 'W';
            }
            else {
                std_energy_unit = 'kWh';
                mega_energy_unit = 'mWh';
                milli_energy_unit = 'Wh';
            }

            value_dict = format_energy_value(agg_source.import, std_energy_unit, mega_energy_unit, milli_energy_unit);
            $("#agg_import").html(value_dict['value']);
            $("#agg_import_unit").html(value_dict['unit']);

            if (agg_source.import > 0) {
                $("#agg_import").removeClass().addClass("metric metric-red");
                $("#agg_import_icon").removeClass().addClass("material-icons metric metric-red");
                $("#agg_import_unit").removeClass().addClass("metric-unit metric-red");
            }
            else {
                $("#agg_import").removeClass().addClass("metric metric-green");
                $("#agg_import_icon").removeClass().addClass("material-icons metric metric-green");
                $("#agg_import_unit").removeClass().addClass("metric-unit metric-green");
            }

            value_dict = format_energy_value(agg_source.solar, std_energy_unit, mega_energy_unit, milli_energy_unit);
            $("#agg_solar").html(value_dict['value']);
            $("#agg_solar_unit").html(value_dict['unit']);

            if (agg_source.solar > 0) {
                $("#agg_solar").removeClass().addClass("metric metric-yellow");
                $("#agg_solar_icon").removeClass().addClass("material-icons metric metric-yellow");
                $("#agg_solar_unit").removeClass().addClass("metric-unit metric-yellow");
            }
            else {
                $("#agg_solar").removeClass().addClass("metric metric-grey");
                $("#agg_solar_icon").removeClass().addClass("material-icons metric metric-grey");
                $("#agg_solar_unit").removeClass().addClass("metric-unit metric-grey");
            }

            value_dict = format_energy_value(agg_source.export, std_energy_unit, mega_energy_unit, milli_energy_unit);
            $("#agg_export").html(value_dict['value']);
            $("#agg_export_unit").html(value_dict['unit']);

            if (agg_source.export > 0) {
                $("#agg_export").removeClass().addClass("metric metric-blue");
                $("#agg_export_icon").removeClass().addClass("material-icons metric metric-blue");
                $("#agg_export_unit").removeClass().addClass("metric-unit metric-blue");
            }
            else {
                $("#agg_export").removeClass().addClass("metric metric-grey");
                $("#agg_export_icon").removeClass().addClass("material-icons metric metric-grey");
                $("#agg_export_unit").removeClass().addClass("metric-unit metric-grey");
            }

            value_dict = format_energy_value(agg_source.consumed, std_energy_unit, mega_energy_unit, milli_energy_unit);
            $("#agg_consumed").html(value_dict['value']);
            $("#agg_consumed_unit").html(value_dict['unit']);

            if (agg_source.import <= 0) {
                $("#agg_consumed").removeClass().addClass("metric metric-green");
                $("#agg_consumed_icon").removeClass().addClass("material-icons metric metric-green");
                $("#agg_consumed_unit").removeClass().addClass("metric-unit metric-green");
            }
            else if (agg_source.solar > 0) {
                $("#agg_consumed").removeClass().addClass("metric metric-orange");
                $("#agg_consumed_icon").removeClass().addClass("material-icons metric metric-orange");
                $("#agg_consumed_unit").removeClass().addClass("metric-unit metric-orange");
            }
            else {
                $("#agg_consumed").removeClass().addClass("metric metric-red");
                $("#agg_consumed_icon").removeClass().addClass("material-icons metric metric-red");
                $("#agg_consumed_unit").removeClass().addClass("metric-unit metric-red");
            }

            if ('battery_charge' in agg_source) {
                $("#agg_battery_charge_col").show();
                value_dict = format_energy_value(agg_source.battery_charge, std_energy_unit, mega_energy_unit, milli_energy_unit);
                $("#agg_battery_charge").html(value_dict['value']);
                $("#agg_battery_charge_unit").html(value_dict['unit']);

                if (agg_source.battery_charge > 0) {
                    $("#agg_battery_charge").removeClass().addClass("metric metric-charge");
                    $("#agg_battery_charge_icon").removeClass().addClass("material-icons metric metric-charge");
                    $("#agg_battery_charge_unit").removeClass().addClass("metric-unit metric-charge");
                }
                else {
                    $("#agg_battery_charge").removeClass().addClass("metric metric-grey");
                    $("#agg_battery_charge_icon").removeClass().addClass("material-icons metric metric-grey");
                    $("#agg_battery_charge_unit").removeClass().addClass("metric-unit metric-grey");
                }
            }
            else {
                $("#agg_battery_charge_col").hide();
            }

            if ('battery_discharge' in agg_source) {
                $("#agg_battery_discharge_col").show();
                value_dict = format_energy_value(agg_source.battery_discharge, std_energy_unit, mega_energy_unit, milli_energy_unit);
                $("#agg_battery_discharge").html(value_dict['value']);
                $("#agg_battery_discharge_unit").html(value_dict['unit']);

                if (agg_source.battery_discharge > 0) {
                    $("#agg_battery_discharge").removeClass().addClass("metric metric-discharge");
                    $("#agg_battery_discharge_icon").removeClass().addClass("material-icons metric metric-discharge");
                    $("#agg_battery_discharge_unit").removeClass().addClass("metric-unit metric-discharge");
                }
                else {
                    $("#agg_battery_discharge").removeClass().addClass("metric metric-grey");
                    $("#agg_battery_discharge_icon").removeClass().addClass("material-icons metric metric-grey");
                    $("#agg_battery_discharge_unit").removeClass().addClass("metric-unit metric-grey");
                }
            }
            else {
                $("#agg_battery_discharge_col").hide();
            }

            if ('battery_soc' in agg_source) {
                $("#agg_battery_soc_col").show();
                battery_soc_icon = format_battery_icon(agg_source.battery_soc);
                $("#agg_battery_soc").html(agg_source.battery_soc);
                $("#agg_battery_soc_unit").html('%');
                $("#agg_battery_soc_icon").html(battery_soc_icon);

                if (agg_source.battery_soc >= 50) {
                    $("#agg_battery_soc").removeClass().addClass("metric metric-green");
                    $("#agg_battery_soc_icon").removeClass().addClass("material-icons metric metric-green");
                    $("#agg_battery_soc_unit").removeClass().addClass("metric-unit metric-green");
                }
                else if (agg_source.battery_soc >= 30) {
                    $("#agg_battery_soc").removeClass().addClass("metric metric-orange");
                    $("#agg_battery_soc_icon").removeClass().addClass("material-icons metric metric-orange");
                    $("#agg_battery_soc_unit").removeClass().addClass("metric-unit metric-orange");
                }
                else {
                    $("#agg_battery_soc").removeClass().addClass("metric metric-red");
                    $("#agg_battery_soc_icon").removeClass().addClass("material-icons metric metric-red");
                    $("#agg_battery_soc_unit").removeClass().addClass("metric-unit metric-red");
                }
            }
            else {
                $("#agg_battery_soc_col").hide();
            }

            value_dict = format_energy_value(agg_source.co2, 'kg', 'mt', 'g');
            $("#agg_co2").html(value_dict['value']);
            $("#agg_co2_unit").html(value_dict['unit']);

            if (agg_source.co2 > 0) {
                $("#agg_co2").removeClass().addClass("metric metric-green");
                $("#agg_co2_icon").removeClass().addClass("material-icons metric metric-green");
                $("#agg_co2_unit").removeClass().addClass("metric-unit metric-green");
            }
            else {
                $("#agg_co2").removeClass().addClass("metric metric-grey");
                $("#agg_co2_icon").removeClass().addClass("material-icons metric metric-grey");
                $("#agg_co2_unit").removeClass().addClass("metric-unit metric-grey");
            }

            value_dict = format_trees(agg_source.trees);
            $("#agg_trees").html(value_dict['value']);

            if (agg_source.trees > 0) {
                $("#agg_trees").removeClass().addClass("metric metric-green");
                $("#agg_trees_icon").removeClass().addClass("material-icons metric metric-green");
                $("#agg_trees_unit").removeClass().addClass("metric-unit metric-green");
            }
            else {
                $("#agg_trees").removeClass().addClass("metric metric-grey");
                $("#agg_trees_icon").removeClass().addClass("material-icons metric metric-grey");
                $("#agg_trees_unit").removeClass().addClass("metric-unit metric-grey");
            }

            render_charts();
        }

        // chart globals to avoid memory growth
        var donut_chart;
        var day_chart;
        var month_chart;
        var year_chart;

        // render the Google charts
        function render_charts() {
            console.log("render_charts()");

            column_chart_height = (window.innerHeight - 120) / 3;

            switch(layout) {
                case "small":
                    donut_chart_height = (window.innerHeight) * 0.9;
                    break;

                case "portrait":
                    donut_chart_height = (window.innerHeight) * 0.4;
                    break;

                case "large":
                    donut_chart_height = (window.innerHeight) * 0.40;
                    break;

            }

            // legend font size
            // this is a bit of work
            // we parse layout and determine the CSS ref variable to 
            // use for legend font. Google does not allow us pass that CSS
            // in for the font size. So it needs to rendered in pixels
            switch(layout) {
              case "large":
              legend_font_size_var = "--legend-font-size-large-screen";
              slice_font_size_var = "--slice-font-size-large-screen";
              break;
              case "small":
              legend_font_size_var = "--legend-font-size-small-screen";
              slice_font_size_var = "--slice-font-size-small-screen";
              break;
              case "portrait":
              legend_font_size_var = "--legend-font-size-portrait-screen";
              slice_font_size_var = "--slice-font-size-portrait-screen";
              break;
            }
            // expand that variable into the computed size (which will be x.xxvw)
            legend_font_vw_size = getComputedStyle(document.documentElement).getPropertyValue(legend_font_size_var);
            slice_font_vw_size = getComputedStyle(document.documentElement).getPropertyValue(slice_font_size_var);

            // strip the trailing "vw" text
            // and get the numerical value
            legend_font_vw_number = Number(legend_font_vw_size.replace('vw', ''));
            slice_font_vw_number = Number(slice_font_vw_size.replace('vw', ''));

            // Convert into raw pixels using screen width
            legend_font_px_size = (legend_font_vw_number * window.innerWidth) / 100;
            slice_font_px_size = (slice_font_vw_number * window.innerWidth) / 100;

            // series fields and colour assignments
            const series_fields = ["import", "consumed", "solar", "solar_consumed", "export", "battery_charge", "battery_discharge"];

            const series_labels_long = {
                "import": "Grid Import",
                "consumed": "Total Consumption",
                "solar": "PV Yield",
                "solar_consumed": "PV Consumption",
                "export": "PV Export",
                "battery_charge": "Battery Charge",
                "battery_discharge": "Battery Discharge",
            };

            const series_labels_short = {
                "import": "Grid",
                "consumed": "T-Con",
                "solar": "PV",
                "solar_consumed": "PV-Con",
                "export": "PV-Exp",
                "battery_charge": "Bat-Chg",
                "battery_discharge": "Bat-Dis",
            };

            const series_colours = {
                "import": "#990000",
                "consumed": "#4B0082",
                "solar": "#AAAA00",
                "solar_consumed": "#006600",
                "export": "#00487F",
                "battery_charge": "#5C985C",
                "battery_discharge": "#925EAE",
            };

            // live power distribution 

            if (donut_chart != undefined) {
                donut_chart.clearChart();
            }
            donut_chart = new google.visualization.PieChart(document.getElementById('donut_chart'));

            // donut options (shared)

            // construct donut series and colour lists
            donut_series_list = []
            donut_colour_list = []

            for (series_field of series_fields) {
                if (data_dict.dashboard.donut[series_field]) {
                    donut_series_list.push(series_field)
                    donut_colour_list.push(series_colours[series_field])
                }
            }

            var donut_options = {
                colors: donut_colour_list,
                pieHole: 0.4,
                height: donut_chart_height,
                chartArea:{
                    top:10,
                    bottom:40,
                    left:0,
                    right:0,
                },
                legend: { 
                    alignment: 'center', 
                    position: 'bottom', 
                    maxLines: 3,
                    textStyle: {
                        fontSize: legend_font_px_size,
                        color: 'gray'
                    },
                },
                pieSliceText: 'percentage',
                pieSliceTextStyle: {
                    fontSize: slice_font_px_size,
                },
                backgroundColor: { 
                    fill:'transparent' 
                },
                pieSliceBorderColor: 'transparent',
                tooltip: { 
                    showColorCode: true,
                    textStyle: {
                        fontSize: legend_font_px_size
                    }
                }
            };

            // agg
            agg_source = data_dict.metrics[agg_metric_key];
            var agg_data = new google.visualization.DataTable();
            agg_data.addColumn('string', 'Source');
            agg_data.addColumn('number', 'kWh');

            for (series_field of donut_series_list) {
                agg_data.addRows([
                    [series_labels_short[series_field], agg_source[series_field] * 1000],
                ]);
            }

            // draw donut
            donut_chart.draw(agg_data, donut_options);

            // bar charts
            // only applies to portrait or large layouts
            if (layout == "portrait" || layout == "large") {

                // construct bar_chart series and colour lists
                bar_chart_series_list = []
                bar_chart_colour_list = []

                for (series_field of series_fields) {
                    if (data_dict.dashboard.bar_chart[series_field]) {
                        bar_chart_series_list.push(series_field)
                        bar_chart_colour_list.push(series_colours[series_field])
                    }
                }

                // common options
                // but the hAxis title will be tweaked
                var bar_chart_options = {
                    colors: bar_chart_colour_list,
                    hAxis: {
                        title: 'Hour',
                        titleTextStyle: {
                            color: 'white',
                            fontSize: legend_font_px_size,
                        },
                        textStyle: {
                            color: 'gray',
                            fontSize: legend_font_px_size * 0.9,
                        },
                    },
                    vAxis: {
                        title: 'kwH',
                        titleTextStyle: {
                            color: 'white',
                            fontSize: legend_font_px_size,
                        },
                        textStyle: {
                            color: 'gray',
                            fontSize: legend_font_px_size * 0.9,
                        },
                        gridlines: {
                            color: '#404040', 
                        },
                        minorGridlines: {
                            color: '#404040', 
                        },
                    },
                    chartArea:{
                        left:100, // needed for the kWh counts to fit
                        right:10,
                        backgroundColor: {
                            // chart border
                            stroke: 'gray',
                            strokeWidth: 0
                        }
                    },
                    axisTitlesPosition: 'in',
                    isStacked: true,
                    height: column_chart_height,
                    legend: { 
                        position: 'top', 
                        alignment: 'center', 
                        maxLines: 3,
                        textStyle: {
                            fontSize: legend_font_px_size,
                            color: 'gray'
                        },
                    },
                    backgroundColor: { 
                        fill:'transparent' 
                    },
                    focusTarget: 'category',
                    tooltip: { 
                        showColorCode: true,
                        textStyle: {
                            fontSize: legend_font_px_size
                        }
                    }
                };

                // day
                if (data_dict.day.length > 0) {

                    if (day_chart != undefined) {
                        day_chart.clearChart();
                    }
                    day_chart = new google.visualization.ColumnChart(document.getElementById('day_google_chart'));

                    var day_data = new google.visualization.DataTable();

                    // hour is actually a number (int)
                    // but we chart it as a string
                    day_data.addColumn('string', 'Hour');

                    for (series_field of bar_chart_series_list) {
                        day_data.addColumn('number', series_labels_long[series_field]);
                    }

                    day_data.addRows(data_dict.day.length);
                    row = 0
                    for (const item of data_dict.day) {
                        // format as hh:00
                        time_str = item.hour.toString().padStart(2, '0') 
                        day_data.setCell(row, 0, time_str);
                        col = 1
                        for (series_field of bar_chart_series_list) {
                            if (series_field in item) {
                                day_data.setCell(row, col, item[series_field].toFixed(2));
                            }
                            col += 1;
                        }
                        row += 1;
                    }

                    bar_chart_options.hAxis.title = 'Hour';
                    day_chart.draw(day_data, bar_chart_options);

                    chart_title = `Last ${data_dict.day.length} Hours`;
                    $("#day_chart_title").html(chart_title);
                }

                // month 
                if (data_dict.month.length > 0) {

                    if (month_chart != undefined) {
                        month_chart.clearChart();
                    }
                    month_chart = new google.visualization.ColumnChart(document.getElementById('month_google_chart'));

                    var month_data = new google.visualization.DataTable();
                    // present int day number as string
                    month_data.addColumn('string', 'Day');

                    for (series_field of bar_chart_series_list) {
                        month_data.addColumn('number', series_labels_long[series_field]);
                    }

                    month_data.addRows(data_dict.month.length);
                    row = 0
                    for (const item of data_dict.month) {
                        // Format as 'MMM dd'
                        time_str = item.month + ' ' + item.day.toString().padStart(2, '0') 
                        month_data.setCell(row, 0, time_str);
                        col = 1
                        for (series_field of bar_chart_series_list) {
                            if (series_field in item) {
                                month_data.setCell(row, col, item[series_field].toFixed(2));
                            }
                            col += 1;
                        }
                        row += 1;
                    }

                    bar_chart_options.hAxis.title = 'Day';
                    month_chart.draw(month_data, bar_chart_options);

                    chart_title = `Last ${data_dict.month.length} Days`;
                    $("#month_chart_title").html(chart_title);
                }

                // year
                if (data_dict.year.length > 0) {

                    if (year_chart != undefined) {
                        year_chart.clearChart();
                    }
                    year_chart = new google.visualization.ColumnChart(document.getElementById('year_google_chart'));

                    var year_data = new google.visualization.DataTable();
                    year_data.addColumn('string', 'Month');

                    for (series_field of bar_chart_series_list) {
                        year_data.addColumn('number', series_labels_long[series_field]);
                    }

                    year_data.addRows(data_dict.year.length);
                    row = 0
                    for (const item of data_dict.year) {
                        time_str = item.year + ' ' + item.month
                        year_data.setCell(row, 0, time_str);
                        col = 1
                        for (series_field of bar_chart_series_list) {
                            if (series_field in item) {
                                year_data.setCell(row, col, item[series_field].toFixed(2));
                            }
                            col += 1;
                        }
                        row += 1;
                    }

                    bar_chart_options.hAxis.title = 'Month';
                    year_chart.draw(year_data, bar_chart_options);

                    chart_title = `Last ${data_dict.year.length} Months`;
                    $("#year_chart_title").html(chart_title);
                }
            }
        }

    </script>
</head>   

<body id="bg">

    <!-- initial spash -->
    <div id="splash" class="row justify-content-center">
        <div id="init_splash" class="col col-12 mt-2">
            <div class="card-transparent text-center mt-0">
                <div class="card-body">
                    <span class="metric metric-white">SolarMon </span>
                    <a href="/admin"><span class="material-icons metric metric-white">settings_applications</span></a>
                    <div>
                        <span id="splash_text" class="metric-unit metric-white"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- dashboard will be dynamically populated by set_layout()-->
    <div id="dashboard">
    </div>

</body>
